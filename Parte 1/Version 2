//******************************************/
// Universidad del Valle de Guatemala
// BE3029 - Electronica Digital 2
// Keren Gamarro
// 12/08/2025
// Proyecto: Parte 1 - Sensor de Temperatura con LM35 y botón (con interrupción)
// MCU: ESP32 dev kit 1.0
// mapeo malo, lee valores de 10 grados pero estoy a 20
//******************************************/

#include <Arduino.h>

//******************************************/
// Definiciones
//******************************************/
#define LM35_PIN 32        // Pin del sensor de temperatura (ADC1)
#define BOTON_PIN 33       // Pin del botón (pull-up interno)
#define ADC_RES 4095.0     // Resolución ADC de 12 bits del ESP32
#define VREF 3.3           // Voltaje de referencia del ESP32
#define DEBOUNCE_MS 200    // Tiempo de rebote del botón

//******************************************/
// Variables globales
//******************************************/
volatile bool leer_temp = false;
volatile unsigned long lastPressISR = 0;

//******************************************/
// Prototipos de funciones
//******************************************/
float leerTemperatura();
void IRAM_ATTR botonISR();

//******************************************/
// ISRs Rutinas de Interrupcion
//******************************************/
void IRAM_ATTR botonISR() {
  unsigned long tiempoActual = millis();
  if (tiempoActual - lastPressISR > DEBOUNCE_MS) {
    leer_temp = true;
    lastPressISR = tiempoActual;
  }
}

//******************************************/
// Configuracion
//******************************************/
void setup() {
  Serial.begin(115200);
  pinMode(LM35_PIN, INPUT);
  pinMode(BOTON_PIN, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(BOTON_PIN), botonISR, FALLING);

  Serial.println("\n===== SENSOR DE TEMPERATURA LM35 =====");
  Serial.println("Presiona el botón para leer la temperatura");
  Serial.println("========================================");
}

//******************************************/
// Loop Principal
//******************************************/
void loop() {
  if (leer_temp) {
    leer_temp = false;
    float tempC = leerTemperatura();
    Serial.printf("Temperatura: %.2f °C\n", tempC);
  }
}

//******************************************/
// Otras funciones
//******************************************/
float leerTemperatura() {
  int adcValue = analogRead(LM35_PIN);
  float voltaje = (adcValue / ADC_RES) * VREF;
  float tempC = voltaje * 100.0;
  return tempC;
}
